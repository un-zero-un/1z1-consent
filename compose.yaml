services:
    php:
        image: ${IMAGE_PREFIX:-ghcr.io/un-zero-un/1z1-consent/}php:${IMAGE_TAG:-latest}
        build:
            context: .
            target: php
            args:
                EXTERNAL_USER_ID: ${EXTERNAL_USER_ID:-33}
        command: [ "frankenphp", "run", "--config", "/etc/caddy/Caddyfile" ]
        environment:
            MAIN_DOMAIN: ${MAIN_DOMAIN:-localhost}
            SERVER_NAME: ${SERVER_NAME:-localhost, *.localhost}
            APP_ENV: ${APP_ENV:-prod}
            APP_SECRET: ${APP_SECRET:-!ChangeMe!}
            REDIS_URL: ${REDIS_URL:-redis://redis}
            MAILER_DSN: ${MAILER_DSN:-smtp://smtp:1025}
            DATABASE_URL: ${DATABASE_URL:-postgres://${POSTGRES_USER:-1z1-consent}:${POSTGRES_PASSWORD:-1z1-consent}@database:5432/${POSTGRES_DB:-1z1-consent}}
            AUTHORIZED_ADMIN_EMAIL_DOMAINS: ${AUTHORIZED_ADMIN_EMAIL_DOMAINS:-}
            EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-}
            GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
            GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
        volumes:
            - caddy_data:/data
            - caddy_config:/config
        ports:
            -   target: 80
                published: ${HTTP_PORT:-80}
                protocol: tcp
            -   target: 443
                published: ${HTTPS_PORT:-443}
                protocol: tcp
            -   target: 443
                published: ${HTTP3_PORT:-443}
                protocol: udp

volumes:
    caddy_data:
    caddy_config:
