services:
    php:
        volumes:
            - '.:/app:rw'
            - './infra/docker/php/conf.d/symfony.dev.ini:/usr/local/etc/php/conf.d/symfony.ini:ro'
        depends_on: [ database, redis, smtp ]
        environment:
            MAILER_DSN: smtp://smtp:1025
            REDIS_URL: redis://redis
            DATABASE_URL: postgres://${POSTGRES_USER:-1z1-consent}:${POSTGRES_PASSWORD:-1z1-consent}@database:5432/${POSTGRES_DB:-1z1-consent}
            CADDY_SERVER_EXTRA_DIRECTIVES: tls /app/infra/docker/php/tls/cert.pem /app/infra/docker/php/tls/key.pem
            FRANKENPHP_WORKER_CONFIG: watch
            APP_ENV: ${APP_ENV:-dev}
        extra_hosts:
            - host.docker.internal:host-gateway
        tty: true
        command: [ "frankenphp", "run", "--config", "/etc/caddy/Caddyfile", "--watch" ]
        ports:
            -   target: 80
                published: ${HTTP_PORT:-80}
                protocol: tcp
            -   target: 443
                published: ${HTTPS_PORT:-443}
                protocol: tcp
            -   target: 443
                published: ${HTTP3_PORT:-443}
                protocol: udp

    database:
        image: postgres:15
        volumes: [ database-data:/var/lib/postgresql/data ]
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-1z1-consent}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-1z1-consent}
            POSTGRES_DB: ${POSTGRES_DB:-1z1-consent}
        ports:
            -   target: 5432
                published: ${DATABASE_PORT:-5432}
                protocol: tcp

    redis:
        image: redis:7.0
        ports:
            -   target: 6379
                published: ${REDIS_PORT:-6379}
                protocol: tcp

    smtp:
        image: mailhog/mailhog
        ports:
            -   target: 8025
                published: ${SMTP_PORT:-8025}
                protocol: tcp

volumes:
    database-data:
